import ccxt
import pandas as pd
import time
import requests
from datetime import datetime
import pytz
from flask import Flask, send_file # send_file ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∑Ö‡∑è
from threading import Thread
import os

# --- 1. RENDER ‡∑É‡∂ª‡∑ä‡∑Ä‡∂ª‡∑ä ‡∂ë‡∂ö ---
app = Flask('')

@app.route('/')
def home():
    return "Thili Project 1 is Running! <br><br> <a href='/history'>Download Signal History (CSV)</a>"

# ‡∑É‡∑í‡∂ú‡∑ä‡∂±‡∂Ω‡∑ä ‡∂â‡∂≠‡∑í‡∑Ñ‡∑è‡∑É‡∂∫ ‡∂∂‡∑è‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂Ω‡∑í‡∂±‡∑ä‡∂ö‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä
@app.route('/history')
def download_history():
    if os.path.exists("signal_history.csv"):
        return send_file("signal_history.csv", as_attachment=True)
    return "No signals recorded yet."

def run_web_server():
    port = int(os.environ.get("PORT", 8080))
    app.run(host='0.0.0.0', port=port)

# --- 2. 'thili project 1' ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ö‡∑ö‡∂≠‡∂∫ ---
exchange = ccxt.kraken()
sri_lanka_tz = pytz.timezone('Asia/Colombo')

TELEGRAM_TOKEN = '8332489688:AAEsjcVC2AHRVCeKMb6oBGddk1_1BwwZCX0'
CHAT_ID = '1164598763'

# ‡∂î‡∂∫‡∑è ‡∂≠‡∑ì‡∂ª‡∂´‡∂∫ ‡∂ö‡∑Ö Top 50 ‡∂ö‡∑è‡∑É‡∑í ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä ‡∂∏‡∑ô‡∂≠‡∂±‡∂ß ‡∂Ø‡∑è‡∂±‡∑ä‡∂±
symbols = ['BTC/USDT', 'ETH/USDT', 'SOL/USDT', 'XRP/USDT', 'LINK/USDT', 'ADA/USDT']

def save_signal_to_csv(data):
    """‡∑É‡∑í‡∂ú‡∑ä‡∂±‡∂Ω‡∑ä ‡∂ë‡∂ö CSV ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö‡∂ö‡∂ß ‡∑É‡∑ö‡∑Ä‡∑ä ‡∂ö‡∂ª‡∂± ‡∑Ü‡∂±‡∑ä‡∂ö‡∑ä‡∑Ç‡∂±‡∑ä ‡∂ë‡∂ö"""
    df = pd.DataFrame([data])
    # ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö ‡∂±‡∑ê‡∂≠‡∑ä‡∂±‡∂∏‡∑ä ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑í‡∂±‡∑ä ‡∑Ñ‡∂Ø‡∂±‡∑Ä‡∑è, ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑Ä‡∑è ‡∂±‡∂∏‡∑ä ‡∂Ö‡∂±‡∑ä‡∂≠‡∑í‡∂∏‡∂ß ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑Ä‡∑è
    if not os.path.isfile('signal_history.csv'):
        df.to_csv('signal_history.csv', index=False)
    else:
        df.to_csv('signal_history.csv', mode='a', header=False, index=False)

def send_telegram_msg(message):
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage?chat_id={CHAT_ID}&text={message}&parse_mode=Markdown"
    try: requests.get(url)
    except: pass

def get_volume_ratio(symbol, timeframe):
    try:
        bars = exchange.fetch_ohlcv(symbol, timeframe=timeframe, limit=30)
        df = pd.DataFrame(bars, columns=['time', 'open', 'high', 'low', 'close', 'volume'])
        df['vol_ma'] = df['volume'].rolling(window=20).mean()
        ratio = df['volume'].iloc[-1] / df['vol_ma'].iloc[-1]
        return ratio, df['close'].iloc[-1]
    except: return 0, 0

def monitor_market():
    print("Whale Monitoring Started with History Logging...")
    
    while True:
        try:
            for symbol in symbols:
                ratio_1h, price = get_volume_ratio(symbol, '1h')
                
                if ratio_1h > 2.5:
                    ratio_5m, _ = get_volume_ratio(symbol, '5m')
                    
                    if ratio_5m > 2.0:
                        time_now = datetime.now(sri_lanka_tz).strftime('%Y-%m-%d %I:%M %p')
                        
                        # 1. ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂â‡∂≠‡∑í‡∑Ñ‡∑è‡∑É‡∂∫‡∂ß ‡∑É‡∑ö‡∑Ä‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
                        signal_data = {
                            "Time": time_now,
                            "Symbol": symbol,
                            "Price": price,
                            "Ratio_1h": f"{ratio_1h:.2f}",
                            "Ratio_5m": f"{ratio_5m:.2f}"
                        }
                        save_signal_to_csv(signal_data)
                        
                        # 2. ‡∂ß‡∑ô‡∂Ω‡∑í‡∂ú‡∑ä‚Äç‡∂ª‡∑ë‡∂∏‡∑ä ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏
                        msg = (f"üö® *CONFIRMED WHALE MOVEMENT* üö®\n\n"
                               f"üíé *‡∂ö‡∑è‡∑É‡∑í‡∂∫:* {symbol}\n"
                               f"üí∞ *‡∂∏‡∑í‡∂Ω:* ${price}\n"
                               f"üìä *1h Ratio:* {ratio_1h:.2f}x\n"
                               f"‚ö° *5m Ratio:* {ratio_5m:.2f}x\n"
                               f"‚è∞ *‡∑Ä‡∑ö‡∂Ω‡∑è‡∑Ä:* {time_now}")
                        send_telegram_msg(msg)
            
            time.sleep(120)
        except Exception as e:
            time.sleep(30)

if __name__ == "__main__":
    t = Thread(target=monitor_market)
    t.start()
    run_web_server()
